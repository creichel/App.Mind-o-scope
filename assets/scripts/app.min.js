function buildMindmap(e,t){"use strict";function n(){return window.innerWidth>window.innerHeight?window.innerHeight-50:window.innerWidth}function l(e){var t=0;return e.children&&e.children.forEach(function(e){var n=l(e);n>t&&(t=n)}),1+t}function i(e){if(e.children){for(var t=0;t<e.children.length;t++){var n=e.children[t];i(n)}1===e.children.length&&e.children.push({name:"===placeholder===",children:[{name:"===placeholder===",children:[]}]})}}function s(e){for(var t=e.length-1;t>=0;t--){var n=e[t];"===placeholder==="===n.name?e.splice(t,1):n.children&&s(n.children)}}function o(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.children&&1===n.children.length){var l=n.x-n.children[0].x;n.children[0].x+=l,c(n.children[0],l)}}}function c(e,t){if(e.children)for(var n=0;n<e.children.length;n++)e.children[n].x+=t,c(e.children[n],t)}function r(e){for(var t=e[0].x,n=e[0].y,l=0;l<e.length;l++){var i=e[l];i.x-=t,i.y-=n}}function a(e,t){var n=window.location.href;if(n.indexOf(e+"=")>=0){var l=n.substring(0,n.indexOf(e)),i=n.substring(n.indexOf(e));i=i.substring(i.indexOf("=")+1),i=i.indexOf("&")>=0?i.substring(i.indexOf("&")):"",n=l+e+"="+t+i}else n+=n.indexOf("?")<0?"?"+e+"="+t:"&"+e+"="+t;d(n,se)}function d(e,t){document.getElementById("shareURL").value=e.split("?")[0],document.title=t}function u(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){4==t.readyState&&200==t.status&&(document.getElementById("A1").innerHTML=t.status,document.getElementById("A2").innerHTML=t.statusText,document.getElementById("A3").innerHTML=t.responseText)},t.open("post",e,!0),t.send()}function f(e){var t=0;return Ie.selectAll("circle").data(e).enter().append("circle").attr("class",function(e){var t=ee+(e.parent?e.children?"":" "+te:" "+ne);return t+=e.depth%2===0?" "+Y:" "+_}).attr("r",function(e){return e.r}).style("fill",function(e){if(1===e.depth&&t++,e.children||1===e.depth){if(e.depth%2===0)return Le(t);var n=d3.hsl(Le(t)),l=d3.hsl("hsl("+n.h+","+100*n.s*1.09+"%,"+100*n.l*1.2+"%)");return l}return null})}function h(e,t){return Ie.selectAll("g.label").data(e).enter().append("g").attr("class","label").style("opacity",function(e){return e.parent===t?1:0}).style("display",function(e){return e.parent===t?"inline":"none"}).attr("transform","translate(0,"+De+")").append("foreignObject").attr("width",120).attr("x",-60).attr("height",200).attr("y",-100).append("xhtml:div").classed("labelContainer",!0).html(function(e){return"<div><span>"+e.name+"</span></div>"})}function p(e){var t=12,n=0,l=d3.layout.tree(),i=me.append("ul"),s=l.nodes(e),o=i.selectAll("li."+le).data(s),c=o.enter().append("li").attr("class",function(e){var t=le+(e.parent?e.children?"":" "+te:" "+ne);return t+=e.depth%2===0?" "+Y:" "+_}).style("opacity",1).style("background-color",function(e){return ze(e.depth)}).append("span").attr("class","value").style("padding-left",function(e){return 30+e.depth*t+"px"}).html(function(e){return e.name}),r=i.selectAll("li."+le).filter(function(e,t){return 0===t}).node().getBoundingClientRect().top;s.forEach(function(e,l){var s=i.selectAll("li."+le).filter(function(e,t){return t===l}).node().getBoundingClientRect().top;e.x=s-r,e.y=e.depth*t,1===e.depth&&n++,e.value=n}),c.append("span").attr("class",function(e){return"point"+(e.parent?e.children?"":" "+te:" "+ne)}).style("padding-left",function(e){return e.depth*t+"px"}).style("color",function(e){var t=d3.hsl(Le(e.value)),n=d3.hsl("hsl("+t.h+","+100*t.s*1.09+"%,"+100*t.l*1.2+"%)");return n});var a=me.node().getBoundingClientRect().width,d=me.node().getBoundingClientRect().height,u={top:16,right:10,bottom:10,left:14},f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("step-before");return me.append("svg").attr("width",a-u.left-u.right+"px").attr("height",d+"px").append("g").attr("transform","translate("+u.left+","+u.top+")").selectAll("path.link").data(l.links(s)).enter().insert("path",":first-child").attr("class","link").attr("stroke",function(e){var t=d3.hsl(Le(e.target.value)),n=d3.hsl("hsl("+t.h+","+100*t.s*1.09+"%,"+100*t.l*1.2+"%)");return n}).attr("d",function(e){return f([{y:e.source.x,x:e.source.y},{y:e.target.x,x:e.target.y}])}),o}function v(e){var n=He;if(He=e,I(e),He!==n){null==e.parent?fe.attr("disabled","true"):fe.attr("disabled",null);var l=d3.transition().duration(d3.event.altKey?10*t:t).tween("zoom",function(){var e=d3.interpolateZoom(Pe,[He.x,He.y,2*He.r]);return function(t){g(e(t))}});l.selectAll("g.label").filter(function(e){return e.parent===He||"inline"===this.style.display}).style("opacity",function(e){return e.parent===He?1:0}).each("start",function(e){e.parent===He&&(this.style.display="inline")}).each("end",function(e){e.parent!==He&&(this.style.display="none")})}}function g(e){var t=Re/e[2];Pe=e,Ve.classed(G,!1).filter(function(e){return He===e}).classed(G,!0),qe.classed(G,!1).filter(function(e){return He===e}).classed(G,!0),qe.attr("transform",function(n){return"translate("+(n.x-e[0])*t+","+(n.y-e[1])*t+")"}),We.attr("r",function(e){return e.r*t})}function y(){pe.classed(N,!pe.classed(N)),Fe===!1?(M(),ue.classed("active",!0),Fe=!0,setTimeout(function(){ye.node().focus()},300)):(ue.classed("active",!1),Fe=!1,w(),ye.node().blur())}function m(){ue.classed("active",!1),pe.classed(N,!1),Fe=!1,ye.node().blur(),w()}function x(){ve.classed(N,!ve.classed(N)),ge.classed(G,!ge.classed(G)),pe.classed("visibleSettings",!pe.classed("visibleSettings"))}function w(){ve.classed(N,!1),ge.classed(G,!1)}function b(e){w(),Ve.classed(Q,!0).filter(function(t){var n=t.name;return n.toLowerCase().indexOf(e.toLowerCase())>-1}).classed(Q,!1),qe.classed(Q,!0).filter(function(t){var n=t.name;return n.toLowerCase().indexOf(e.toLowerCase())>-1}).classed(Q,!1),""!==e?(me.select("svg").style("display","none"),he.text(e).classed(N,!0).on("click",function(){he.classed(N,!1),document.getElementById("search").value="",Ve.classed(Q,!1),qe.classed(Q,!1),me.select("svg").style("display",null)})):(he.classed(N,!1),me.select("svg").style("display",null))}function k(e){a("zoom",e),t=e}function C(e){a("visited",e?"y":""),d3.select("body").classed("hide-visited",e)}function E(e){a("labels",e?"y":""),d3.select("body").classed("hide-labels",e)}function A(e){a("tooltips",e?"y":""),d3.select("body").classed("hide-tooltip",e)}function B(){window.location="download.php?hash="+e}function D(){R()}function O(){u("delete.php?hash="+e),R()}function R(){L(),re.classed("hover",!1).classed("error",!1).classed("dropped",!1).classed("success",!1).classed("dz-processing",!1).classed("dz-complete",!1),d3.select("body").style("position","relative"),ce.style("display","block"),ae.style("display","none");var e=window.location.href,t=e.substring(0,e.lastIndexOf("/"));d(t,ie)}function L(){de.select("svg").remove(),me.select("ul").remove(),me.select("svg").remove(),d3.select("#path .content").html(""),ye.value="",he.classed(N,!1),m(),w()}function z(e){d3.select(window).on("resize",function(){T(),M()}),d3.select("#"+W).on("click",function(){v(e),m()}),fe.on("click",function(){v(e)});var t;We.on("click",function(e){Me.attr("class","d3-tip"),Me.hide(e),d3.select(this).classed(J,!0),He!==e?(m(),v(e),d3.event.stopPropagation()):null!=e.parent&&(v(e.parent),d3.event.stopPropagation())}).on("mouseover",function(e){Me.show(e),t=setTimeout(function(){Me.attr("class","d3-tip show")},300)}).on("mouseout",function(e){clearTimeout(t),Me.attr("class","d3-tip"),Me.hide(e)}),ue.on("click",function(){y()}),Ve.on("click",function(e){e.children?He!==e&&(v(e),d3.event.stopPropagation()):He!==e.parent&&(v(e.parent),d3.event.stopPropagation())}).on("mouseover",function(e,t){qe.filter(function(e,n){return t===n}).classed(Z,!0)}).on("mouseout",function(e,t){qe.filter(function(e,n){return t===n}).classed(Z,!1)}),ge.on("click",function(){x()}),ye.on("input",function(){v(e),b(this.value)}),d3.selectAll("input").on("focus",function(){d3.event.preventDefault()}),xe.on("change",function(){C(this.checked)}),we.on("change",function(){E(this.checked)}),be.on("change",function(){A(this.checked)}),ke.on("mousedown",function(){d3.select("#zoomDurationOutput").classed("active",!0)}).on("mouseout",function(){d3.select("#zoomDurationOutput").classed("active",!1)}).on("change",function(){k(this.value)}),Ce.on("click",function(){B()}),Ee.on("click",function(){D()}),Ae.on("click",function(){}),d3.select("body").on("keydown",function(){Fe||70!=d3.event.keyCode?27==d3.event.keyCode&&(d3.event.preventDefault(),y()):(d3.event.preventDefault(),y())})}function T(){d3.select("body").style("position","relative"),Be=document.getElementById(W).offsetWidth,De=document.getElementById(W).offsetHeight,Re=n(),d3.select("#"+W).select("svg").style("width",Be+"px").style("height",De+"px").select("g").attr("transform","translate("+Be/2+","+(De/2+H/2)+")"),d3.select(self.frameElement).style("height",Re+"px"),d3.select("body").style("position","fixed"),M()}function I(e){function t(e,n){if(null!=e.parent){e=e.parent,n.insert("span",":first-child").attr("class","divider");var l=e.depth+2>He.depth||e.depth<2?e.name:"···";n.insert("button",":first-child").text(l).on("click",function(){m(),v(e)}).on("mouseover",function(){"···"===l&&d3.select(this).classed("show-tip",!0),We.filter(function(t){return e===t}).classed(Z,!0)}).on("mouseout",function(){"···"===l&&d3.select(this).classed("show-tip",!1),We.filter(function(t){return e===t}).classed(Z,!1)}).append("span").text(e.name).classed("path-tip",!0).attr("style",function(){return"margin-left: -"+d3.select(this).node().getBoundingClientRect().width/2+"px"}),t(e,n)}}var n=d3.select("#path .content");n.html(""),n.append("span").attr("class",G).text(e.name),t(e,n)}function M(){var e=De-pe.select("header").node().getBoundingClientRect().height-pe.select(".searchbar").node().getBoundingClientRect().height-pe.select("footer").node().getBoundingClientRect().height;pe.select(".content").style("height",e+"px"),pe.select(".scrollmask").style("height",e+"px")}function F(t){d3.json(t,function(t,n){if(t)throw t;T(),I(n),Ve=p(n),i(n),He=n,Se=Te.nodes(n),console.log("Depth of the Mind Map: "+l(n)),ze.domain([0,l(n)]),s(Se),o(Se),console.log("Structure:"),console.log(n),We=f(Se),je=h(Se,n),z(n),qe=Ie.selectAll("circle,g.label"),g([n.x,n.y,2*n.r+H]),C(d3.select("#hideVisited").node().checked),E(d3.select("#hideLabels").node().checked),A(d3.select("#disableTooltip").node().checked);var c=window.location.href,r=c.substring(0,c.lastIndexOf("/"))+"/"+e+location.search;se=n.name+" | "+ie,d(r,se)})}var H=35,S=1.5,P=3,W="content",j="#sidebar",V="#menubutton",q="#toRoot",K="#treelist",U="#settings",X="#openSettings",Z="hover",G="active",J="visited",N="show",Q="hide",Y="even",_="odd",ee="node",te="leaf",ne="root",le="item",ie="Mind-o-scope",se,oe="uploaded/",ce=d3.select("#upload"),re=d3.select(".dropzone"),ae=d3.select("#mindmap"),de=d3.select("#"+W),ue=d3.select(V),fe=d3.select(q),he=d3.select("#searchterm"),pe=d3.select(j),ve=pe.select(U),ge=pe.select(X),ye=pe.select("#search"),me=pe.select(K),xe=d3.select("#hideVisited"),we=d3.select("#hideLabels"),be=d3.select("#disableTooltip"),ke=d3.select("#zoomDuration"),Ce=d3.select("#download"),Ee=d3.select("#new"),Ae=d3.select("#delete"),Be=window.innerWidth,De=window.innerHeight,Oe=oe+e+".json",Re=n(),Le=d3.scale.ordinal().range(["#EF721F","#4E9CEE","#36D63D","#DEC815","#E076E7","#75AE29","#E8A117","#39CD68","#A886F2","#C985D6","#CA8025","#ABA414","#F46841","#A0CB1C","#50AB46","#75CE2F","#8E94E8","#33B22E","#61D350","#E58222"]),ze=d3.scale.linear().domain([0,8]).range(["#FCFCFC","#D4D4D4"]).interpolate(d3.interpolateRgb),Te=d3.layout.pack().padding(S).size([Re-H,Re-H]).value(function(e){return Math.pow(1/e.depth,P)}).sort(function(e,t){return-(e.value-t.value)});L();var Ie=de.append("svg").append("g"),Me=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return e.name});Ie.call(Me);var Fe=!1,He,Se,Pe,We,je,Ve,qe;ce.style("display","none"),ae.style("display","block"),F(Oe)}